# 11 — 编码规范文档

---

## 1. 概述

本文档定义了 PNNE 项目的编码规范，确保代码风格一致、可读性强、易于维护。所有贡献者必须遵守这些规范。

### 1.1 原则

| 原则 | 说明 |
|------|------|
| **一致性** | 代码风格在整个项目中保持一致 |
| **可读性** | 代码易于理解，命名清晰 |
| **简洁性** | 避免冗余代码，保持简洁 |
| **可维护性** | 易于修改和扩展 |
| **文档化** | 充分的注释和文档字符串 |

---

## 2. 命名规范

### 2.1 变量和函数命名

**规则：**
- 使用 `snake_case` 小写下划线风格
- 变量名应具有描述性
- 布尔变量使用 `is_`, `has_`, `can_` 前缀
- 私有变量/方法使用单下划线 `_` 前缀

```python
# 正确示例
node_count = 10
is_enabled = True
has_children = False
learning_rate = 0.001

def calculate_loss(predictions, targets):
    pass

def _internal_helper():
    pass

# 错误示例
nodeCount = 10  # 应使用下划线
n = 10  # 不够描述性
enabled = True  # 布尔值应使用 is_ 前缀
```

### 2.2 类命名

**规则：**
- 使用 `PascalCase` 大写驼峰风格
- 类名应为名词
- 基类/抽象类可以使用 `Base` 前缀
- 异常类使用 `Error` 或 `Exception` 后缀

```python
# 正确示例
class Node:
    pass

class LinearNode(Node):
    pass

class BasePlugin:
    pass

class NodeNotFoundException(Exception):
    pass

# 错误示例
class node:  # 应使用大写驼峰
    pass

class Run:  # 应为名词，不是动词
    pass
```

### 2.3 常量命名

**规则：**
- 使用 `UPPER_SNAKE_CASE` 全大写下划线风格
- 模块级常量放在文件顶部

```python
# 正确示例
MAX_CONNECTIONS = 1000
DEFAULT_LEARNING_RATE = 0.001
PIN_DIRECTION_INPUT = "input"

# 错误示例
maxConnections = 1000  # 应使用全大写下划线
```

### 2.4 文件和模块命名

**规则：**
- 使用 `snake_case` 小写下划线风格
- 文件名应简洁且描述性
- 避免使用Python保留字

```python
# 正确示例
node.py
pin.py
connection.py
node_graphics_item.py

# 错误示例
Node.py  # 应使用小写
nodeGraphicsItem.py  # 应使用下划线
```

---

## 3. 代码格式

### 3.1 缩进和空格

- 使用 **4个空格** 缩进，不使用Tab
- 运算符两侧留一个空格
- 逗号后留一个空格
- 函数参数括号内不留空格

```python
# 正确示例
def foo(a, b, c):
    result = a + b * c
    return result

# 错误示例
def foo( a,b,c ):  # 括号内不应留空格，逗号后应留空格
    result=a+b*c  # 运算符两侧应留空格
    return result
```

### 3.2 行长度

- 每行最多 **100个字符**
- 过长的行使用反斜杠 `\` 或括号换行

```python
# 正确示例
long_variable_name = some_function(
    arg1, arg2, arg3,
    arg4, arg5
)

# 或者
long_variable_name = some_function(arg1, arg2, arg3, \
                                   arg4, arg5)
```

### 3.3 空行

- 顶层函数和类定义之间留 **2个空行**
- 类内方法之间留 **1个空行**
- 函数内逻辑段之间可留1个空行

```python
class Node:
    
    def __init__(self):
        self.id = None
        
    def forward(self, inputs):
        # 预处理
        processed = self._preprocess(inputs)
        
        # 执行
        result = self._execute(processed)
        
        return result


class Pin:
    
    def __init__(self):
        pass
```

### 3.4 Import顺序

**规则：**
1. 标准库
2. 第三方库
3. 本地模块

每组之间留一个空行。

```python
# 标准库
import os
import sys
from typing import List, Dict

# 第三方库
import torch
import numpy as np
from PyQt6.QtCore import Qt, Signal

# 本地模块
from core.base.node import Node
from core.base.pin import Pin
```

---

## 4. 注释规范

### 4.1 文档字符串 (Docstring)

**规则：**
- 所有公共模块、类、函数必须有文档字符串
- 使用三引号 `"""`
- 采用 Google 风格或 NumPy 风格

```python
def calculate_loss(predictions: torch.Tensor, targets: torch.Tensor) -> float:
    """
    计算预测值与目标值之间的损失。
    
    Args:
        predictions (torch.Tensor): 模型预测值，形状为 [batch, classes]
        targets (torch.Tensor): 真实标签，形状为 [batch]
        
    Returns:
        float: 损失值
        
    Raises:
        ValueError: 当预测值和目标值形状不匹配时
        
    Examples:
        >>> predictions = torch.randn(32, 10)
        >>> targets = torch.randint(0, 10, (32,))
        >>> loss = calculate_loss(predictions, targets)
        >>> print(loss)
        1.234
    """
    if predictions.size(0) != targets.size(0):
        raise ValueError("Batch size mismatch")
    
    return F.cross_entropy(predictions, targets).item()
```

### 4.2 行内注释

**规则：**
- 使用 `#` 开头
- 与代码之间至少留2个空格
- 避免冗余注释（代码自明的不需要注释）

```python
# 正确示例
x = x + 1  # 增加计数器

# 创建新节点
node = Node()

# 错误示例
x = x + 1  # x加1（冗余，代码已经很清楚）
```

### 4.3 TODO注释

**规则：**
- 使用 `# TODO:` 标记待办事项
- 包含负责人和日期

```python
# TODO(username, 2026-02-14): 实现缓存机制
def load_data(self, path):
    pass
```

---

## 5. 类型注解

### 5.1 函数签名

**规则：**
- 所有公共函数必须有类型注解
- 使用 `typing` 模块

```python
from typing import List, Dict, Optional, Union

def process_nodes(nodes: List[Node]) -> Dict[str, Node]:
    """处理节点列表"""
    pass

def get_node_by_id(node_id: str) -> Optional[Node]:
    """根据ID获取节点"""
    pass

def connect(source: Union[Node, str], target: Union[Node, str]) -> bool:
    """连接两个节点"""
    pass
```

### 5.2 变量注解

```python
# 类属性
class Node:
    id: str
    position: QPointF
    children: List['Node']
    
    def __init__(self):
        self.id = ""
        self.position = QPointF()
        self.children = []

# 复杂类型
from typing import TypeAlias

NodeID: TypeAlias = str
NodeDict: TypeAlias = Dict[NodeID, Node]
```

---

## 6. 错误处理

### 6.1 异常使用

**规则：**
- 优先使用内置异常类
- 必要时自定义异常
- 避免裸 `except:`

```python
# 正确示例
try:
    node = node_graph.get_node(node_id)
except KeyError:
    logger.error(f"节点不存在: {node_id}")
    raise NodeNotFoundException(f"Node {node_id} not found")

# 错误示例
try:
    node = node_graph.get_node(node_id)
except:  # 不应使用裸 except
    pass
```

### 6.2 自定义异常

```python
class PNNEException(Exception):
    """PNNE基础异常类"""
    pass

class NodeException(PNNEException):
    """节点相关异常"""
    pass

class NodeNotFoundException(NodeException):
    """节点未找到异常"""
    pass
```

---

## 7. 测试规范

### 7.1 测试文件组织

**规则：**
- 测试文件放在 `tests/` 目录
- 测试文件名以 `test_` 开头
- 测试类名以 `Test` 开头
- 测试方法名以 `test_` 开头

```python
# tests/test_node.py

class TestNode(unittest.TestCase):
    
    def setUp(self):
        """测试前准备"""
        self.node = Node()
    
    def test_create_node(self):
        """测试节点创建"""
        self.assertIsNotNone(self.node.id)
    
    def test_add_pin(self):
        """测试添加引脚"""
        pin = Pin("input", PinDirection.INPUT)
        self.node.add_pin(pin)
        self.assertEqual(len(self.node.pins), 1)
```

### 7.2 测试覆盖率

- 单元测试覆盖率目标：**>= 80%**
- 核心模块覆盖率目标：**>= 90%**

---

## 8. Git提交规范

### 8.1 提交信息格式

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type类型：**
- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 重构
- `test`: 测试相关
- `chore`: 构建工具、依赖更新

**示例：**
```
feat(node): 添加子网嵌套支持

- 实现SubnetNode类
- 添加SubnetInputNode和SubnetOutputNode
- 更新NodeGraph以支持子图

Closes #123
```

### 8.2 分支命名

- `feature/feature-name` - 新功能
- `bugfix/bug-description` - Bug修复
- `hotfix/critical-fix` - 紧急修复
- `refactor/refactor-description` - 重构

---

## 9. 日志规范

### 9.1 日志级别

| 级别 | 用途 |
|------|------|
| `DEBUG` | 详细调试信息 |
| `INFO` | 一般信息 |
| `WARNING` | 警告信息 |
| `ERROR` | 错误信息 |
| `CRITICAL` | 严重错误 |

### 9.2 日志格式

```python
import logging

logger = logging.getLogger(__name__)

# DEBUG: 详细信息
logger.debug(f"Processing node {node.id}")

# INFO: 重要事件
logger.info(f"Model training started, epochs={epochs}")

# WARNING: 潜在问题
logger.warning(f"Connection disabled: {connection.id}")

# ERROR: 错误
logger.error(f"Failed to load project: {path}", exc_info=True)

# CRITICAL: 严重错误
logger.critical(f"Application crash: {error}")
```

---

## 10. 性能优化指南

### 10.1 通用原则

- **过早优化是万恶之源** - 先保证正确性，再优化性能
- **测量再优化** - 使用profiler找到瓶颈
- **缓存计算结果** - 避免重复计算

### 10.2 Python性能建议

```python
# 使用列表推导式（快）
squares = [x*x for x in range(1000)]

# 避免使用循环（慢）
squares = []
for x in range(1000):
    squares.append(x*x)

# 使用生成器处理大数据
def read_large_file(path):
    with open(path) as f:
        for line in f:
            yield line.strip()

# 使用 __slots__ 减少内存
class Node:
    __slots__ = ['id', 'name', 'type']
```

---

## 11. 安全规范

### 11.1 输入验证

```python
def set_learning_rate(self, lr: float):
    """设置学习率"""
    if not isinstance(lr, (int, float)):
        raise TypeError("Learning rate must be numeric")
    if lr <= 0 or lr > 1.0:
        raise ValueError("Learning rate must be in (0, 1]")
    self.learning_rate = lr
```

### 11.2 文件操作

```python
# 使用上下文管理器
with open(path, 'r') as f:
    data = f.read()

# 验证文件路径
import os
if not os.path.exists(path):
    raise FileNotFoundError(f"File not found: {path}")
```

---

## 12. 代码审查清单

### 12.1 提交前检查

- [ ] 代码符合命名规范
- [ ] 所有公共API有文档字符串
- [ ] 添加了必要的类型注解
- [ ] 单元测试通过
- [ ] 代码覆盖率达标
- [ ] 没有 TODO 注释（或已创建Issue）
- [ ] 格式化工具（black）已运行
- [ ] Linter（flake8）检查通过
- [ ] 类型检查（mypy）通过

### 12.2 Code Review清单

- [ ] 代码逻辑正确
- [ ] 错误处理完善
- [ ] 性能无明显问题
- [ ] 安全性考虑
- [ ] 文档完整
- [ ] 测试充分
- [ ] 向后兼容性

---

## 13. 工具配置

### 13.1 Black (代码格式化)

```toml
# pyproject.toml
[tool.black]
line-length = 100
target-version = ['py310']
include = '\.pyi?$'
exclude = '''
/(
    \.git
  | \.venv
  | build
  | dist
)/
```

### 13.2 Flake8 (代码检查)

```ini
# .flake8
[flake8]
max-line-length = 100
exclude = .git,__pycache__,build,dist,.venv
ignore = E203,W503
```

### 13.3 Mypy (类型检查)

```ini
# mypy.ini
[mypy]
python_version = 3.10
warn_return_any = True
warn_unused_configs = True
disallow_untyped_defs = True
```

### 13.4 Pytest (测试)

```ini
# pytest.ini
[pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts = --cov=core --cov-report=html --cov-report=term
```

---

## 14. 参考资源

- [PEP 8 -- Style Guide for Python Code](https://peps.python.org/pep-0008/)
- [PEP 257 -- Docstring Conventions](https://peps.python.org/pep-0257/)
- [Google Python Style Guide](https://google.github.io/styleguide/pyguide.html)
- [PyTorch Contributing Guide](https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md)

---

*文档版本: v1.0*  
*最后更新: 2026-02-14*  
*文档状态: 已完成*