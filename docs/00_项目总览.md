# PyTorch Node Network Editor (PNNE)
## 项目总览文档

---

## 1. 项目简介

**PyTorch Node Network Editor (PNNE)** 是一个基于 PyQt6 的桌面应用程序，提供可视化节点编辑界面来构建、调试和训练 PyTorch 深度学习模型。其设计理念深度参考 Houdini 的节点式工作流，采用层次化路径系统和子网嵌套机制，让用户能够以直观的方式搭建复杂的神经网络架构。

---

## 2. 核心特性

| 特性 | 描述 |
|------|------|
| **可视化节点编辑** | 拖拽式节点创建、连接、移动、删除，竖向布局 |
| **层次化路径系统** | `/obj/`、`/vis/`、`/train/` 三大根路径空间 |
| **子网嵌套** | SubNet 节点可无限嵌套，双击进入内部编辑 |
| **实时数据可视化** | 左侧面板显示权重分布、特征图、梯度热力图等 |
| **表达式引擎** | 参数面板支持表达式关联，读取 Detail 属性 |
| **训练管线** | ForEach 循环节点、DataLoader 调度、训练监控 |
| **Python 脚本节点** | 自定义 Python 代码构建任意层逻辑 |
| **插件扩展** | 通过继承 Node 基类扩展自定义节点类型 |

---

## 3. 技术栈

| 层级 | 技术选型 | 版本要求 |
|------|---------|---------|
| **语言** | Python | >= 3.10 |
| **UI 框架** | PyQt6 | >= 6.5 |
| **深度学习** | PyTorch | >= 2.0 |
| **图算法** | NetworkX | >= 3.0 |
| **科学计算** | NumPy | >= 1.24 |
| **数据可视化** | Matplotlib / PyQtGraph | >= 3.7 / >= 0.13 |
| **图像处理** | Pillow | >= 10.0 |
| **序列化** | JSON (内置) | - |
| **日志** | logging (内置) | - |
| **测试** | pytest | >= 7.0 |

---

## 4. 项目目录结构

```
pytorch_node_editor/
│
├── main.py                          # 程序入口
├── requirements.txt                 # 依赖列表
├── setup.py                         # 安装脚本
├── README.md                        # 项目说明
├── LICENSE                          # 开源许可
│
├── docs/                            # 开发文档
│   ├── 00_项目总览.md
│   ├── 01_架构设计.md
│   ├── 02_开发路线图.md
│   ├── 03_核心节点系统.md
│   ├── 04_UI框架设计.md
│   ├── 05_PyTorch集成.md
│   ├── 06_表达式引擎.md
│   ├── 07_训练管线.md
│   ├── 08_可视化系统.md
│   ├── 09_插件系统.md
│   ├── 10_序列化系统.md
│   ├── 11_编码规范.md
│   ├── 12_API参考.md
│   └── 13_文件清单.md
│
├── config/                          # 配置
│   ├── __init__.py
│   ├── settings.py                  # 全局设置管理
│   ├── default_settings.json        # 默认配置文件
│   ├── keybindings.py               # 快捷键绑定
│   └── themes/                      # 主题配置
│       ├── dark.json
│       └── light.json
│
├── core/                            # 核心引擎
│   ├── __init__.py
│   │
│   ├── base/                        # 基础数据模型
│   │   ├── __init__.py
│   │   ├── node.py                  # 节点基类
│   │   ├── pin.py                   # 引脚类
│   │   ├── connection.py            # 连接类
│   │   ├── node_graph.py            # 节点图管理器
│   │   ├── node_factory.py          # 节点工厂
│   │   ├── node_registry.py         # 节点注册表
│   │   └── path_manager.py          # 路径管理器
│   │
│   ├── nodes/                       # 内置节点类型
│   │   ├── __init__.py
│   │   ├── nn/                      # 神经网络层节点
│   │   │   ├── __init__.py
│   │   │   ├── linear_node.py       # 线性层 nn.Linear
│   │   │   ├── conv_nodes.py        # 卷积层 Conv1d/2d/3d
│   │   │   ├── pool_nodes.py        # 池化层 MaxPool/AvgPool
│   │   │   ├── activation_nodes.py  # 激活函数 ReLU/Sigmoid/Tanh/Softmax
│   │   │   ├── norm_nodes.py        # 归一化 BatchNorm/LayerNorm/GroupNorm
│   │   │   ├── dropout_node.py      # Dropout
│   │   │   ├── rnn_nodes.py         # 循环层 RNN/LSTM/GRU
│   │   │   ├── transformer_nodes.py # Transformer 层
│   │   │   ├── loss_nodes.py        # 损失函数节点
│   │   │   └── optimizer_nodes.py   # 优化器节点
│   │   │
│   │   ├── data/                    # 数据节点
│   │   │   ├── __init__.py
│   │   │   ├── image_loader_node.py # 图片加载
│   │   │   ├── text_loader_node.py  # 文本加载
│   │   │   ├── obj_loader_node.py   # OBJ模型加载
│   │   │   ├── csv_loader_node.py   # CSV加载
│   │   │   ├── dataset_node.py      # Dataset 包装
│   │   │   └── dataloader_node.py   # DataLoader 调度
│   │   │
│   │   ├── logic/                   # 逻辑控制节点
│   │   │   ├── __init__.py
│   │   │   ├── foreach_begin_node.py   # ForEach 循环开始
│   │   │   ├── foreach_end_node.py     # ForEach 循环结束
│   │   │   ├── switch_node.py          # 条件分支
│   │   │   ├── merge_node.py           # 合并节点
│   │   │   └── null_node.py            # 空节点（透传）
│   │   │
│   │   ├── subnet/                  # 子网节点
│   │   │   ├── __init__.py
│   │   │   ├── subnet_node.py       # SubNet 容器节点
│   │   │   ├── subnet_input_node.py # SubNet 内部输入节点
│   │   │   └── subnet_output_node.py# SubNet 内部输出节点
│   │   │
│   │   ├── script/                  # 脚本节点
│   │   │   ├── __init__.py
│   │   │   └── python_node.py       # Python 脚本节点
│   │   │
│   │   └── context/                 # 上下文根节点
│   │       ├── __init__.py
│   │       ├── obj_context_node.py  # /obj/ 根节点
│   │       ├── vis_context_node.py  # /vis/ 根节点
│   │       └── train_context_node.py# /train/ 根节点
│   │
│   ├── engine/                      # 执行引擎
│   │   ├── __init__.py
│   │   ├── graph_executor.py        # 图执行器（拓扑排序+调度）
│   │   ├── torch_compiler.py        # 节点图 → nn.Module 编译器
│   │   ├── training_engine.py       # 训练引擎
│   │   └── inference_engine.py      # 推理引擎
│   │
│   ├── expressions/                 # 表达式系统
│   │   ├── __init__.py
│   │   ├── tokenizer.py             # 词法分析器
│   │   ├── parser.py                # 语法分析器
│   │   ├── ast_nodes.py             # AST 节点定义
│   │   ├── evaluator.py             # 求值器
│   │   └── functions.py             # 内置函数库
│   │
│   ├── serialization/               # 序列化系统
│   │   ├── __init__.py
│   │   ├── serializer.py            # 序列化器
│   │   ├── deserializer.py          # 反序列化器
│   │   ├── project_manager.py       # 项目管理器
│   │   ├── clipboard.py             # 剪贴板管理
│   │   └── format_version.py        # 格式版本管理
│   │
│   └── undo/                        # 撤销/重做系统
│       ├── __init__.py
│       ├── command.py               # 命令基类
│       ├── undo_stack.py            # 撤销栈
│       └── commands/                # 具体命令
│           ├── __init__.py
│           ├── node_commands.py     # 节点相关命令
│           ├── connection_commands.py# 连接相关命令
│           └── property_commands.py # 属性相关命令
│
├── ui/                              # 用户界面
│   ├── __init__.py
│   │
│   ├── main_window.py               # 主窗口
│   │
│   ├── graphics/                    # 节点图形系统
│   │   ├── __init__.py
│   │   ├── node_graphics_scene.py   # 图形场景
│   │   ├── node_graphics_view.py    # 图形视图（缩放、平移、交互）
│   │   ├── node_graphics_item.py    # 节点图形项
│   │   ├── pin_graphics_item.py     # 引脚图形项
│   │   ├── connection_graphics_item.py # 连接线图形项
│   │   ├── node_breadcrumb.py       # 路径导航条（面包屑）
│   │   ├── minimap_widget.py        # 小地图
│   │   └── context_menu.py          # 右键上下文菜单（TAB 节点创建菜单）
│   │
│   ├── panels/                      # 面板
│   │   ├── __init__.py
│   │   ├── data_viewer_panel.py     # 左侧数据可视化面板
│   │   ├── properties_panel.py      # 参数属性面板
│   │   ├── node_library_panel.py    # 节点库面板
│   │   ├── detail_panel.py          # Detail 数据面板
│   │   ├── console_panel.py         # Python 控制台
│   │   └── training_monitor_panel.py# 训练监控面板
│   │
│   ├── widgets/                     # 自定义控件
│   │   ├── __init__.py
│   │   ├── parameter_widgets.py     # 参数编辑控件（Int/Float/String/Bool/Enum/Color）
│   │   ├── expression_editor.py     # 表达式编辑器
│   │   ├── code_editor.py           # 代码编辑器（Python 节点用）
│   │   ├── tensor_viewer.py         # 张量查看器
│   │   ├── matrix_viewer.py         # 矩阵查看器
│   │   ├── image_viewer.py          # 图片查看器
│   │   ├── histogram_widget.py      # 直方图控件
│   │   ├── graph_plot_widget.py     # 曲线图控件
│   │   └── search_bar.py            # 搜索栏
│   │
│   ├── dialogs/                     # 对话框
│   │   ├── __init__.py
│   │   ├── about_dialog.py          # 关于对话框
│   │   ├── settings_dialog.py       # 设置对话框
│   │   ├── export_dialog.py         # 导出对话框
│   │   ├── rename_dialog.py         # 重命名对话框
│   │   └── node_search_dialog.py    # 节点搜索创建对话框
│   │
│   └── themes/                      # 主题渲染
│       ├── __init__.py
│       ├── theme_manager.py         # 主题管理器
│       ├── style_sheet.py           # QSS 样式表生成
│       └── colors.py                # 颜色常量
│
├── utils/                           # 工具模块
│   ├── __init__.py
│   ├── logger.py                    # 日志工具
│   ├── signals.py                   # 全局信号总线
│   ├── math_utils.py                # 数学工具
│   ├── tensor_utils.py              # 张量工具
│   ├── file_utils.py                # 文件工具
│   └── platform_utils.py            # 平台适配工具
│
├── plugins/                         # 插件目录
│   ├── __init__.py
│   ├── plugin_base.py               # 插件基类
│   ├── plugin_manager.py            # 插件管理器
│   └── examples/                    # 示例插件
│       └── custom_layer_plugin/
│           ├── __init__.py
│           └── nodes.py
│
├── resources/                       # 资源文件
│   ├── icons/                       # 图标
│   │   ├── node_icons/              # 节点类型图标
│   │   ├── toolbar_icons/           # 工具栏图标
│   │   └── app_icon.png             # 应用图标
│   ├── fonts/                       # 字体
│   └── templates/                   # 项目模板
│       └── default_project.json
│
├── tests/                           # 测试
│   ├── __init__.py
│   ├── test_core/
│   │   ├── test_node.py
│   │   ├── test_pin.py
│   │   ├── test_connection.py
│   │   ├── test_node_graph.py
│   │   └── test_expressions.py
│   ├── test_nodes/
│   │   ├── test_nn_nodes.py
│   │   ├── test_data_nodes.py
│   │   ├── test_subnet_node.py
│   │   └── test_python_node.py
│   ├── test_engine/
│   │   ├── test_graph_executor.py
│   │   └── test_torch_compiler.py
│   └── test_ui/
│       └── test_main_window.py
│
└── examples/                        # 示例项目
    ├── mnist_classifier/
    │   └── project.json
    ├── simple_cnn/
    │   └── project.json
    ├── vae_example/
    │   └── project.json
    └── resnet_subnet/
        └── project.json
```

---

## 5. 文档索引

| 文档 | 描述 | 主要读者 |
|------|------|---------|
| [01_架构设计](01_架构设计.md) | 系统整体架构、分层设计、数据流 | 架构师/全员 |
| [02_开发路线图](02_开发路线图.md) | 开发阶段划分、里程碑、任务分配 | 项目经理/全员 |
| [03_核心节点系统](03_核心节点系统.md) | Node/Pin/Connection/Graph 详细设计 | 核心开发者 |
| [04_UI框架设计](04_UI框架设计.md) | 主窗口、图形系统、面板、控件设计 | 前端开发者 |
| [05_PyTorch集成](05_PyTorch集成.md) | 层节点实现、模型编译、设备管理 | ML 开发者 |
| [06_表达式引擎](06_表达式引擎.md) | 词法/语法分析、AST、求值、内置函数 | 核心开发者 |
| [07_训练管线](07_训练管线.md) | 训练循环、ForEach 节点、优化器调度 | ML 开发者 |
| [08_可视化系统](08_可视化系统.md) | 数据可视化、权重分布、特征图、训练曲线 | 前端开发者 |
| [09_插件系统](09_插件系统.md) | 插件接口、注册机制、热加载 | 插件开发者 |
| [10_序列化系统](10_序列化系统.md) | 项目保存/加载、剪贴板、版本迁移 | 核心开发者 |
| [11_编码规范](11_编码规范.md) | 命名规范、代码风格、注释要求 | 全员 |
| [12_API参考](12_API参考.md) | 所有公开类和方法的完整签名 | 全员 |
| [13_文件清单](13_文件清单.md) | 每个源文件的职责和实现要点 | 全员 |

---

## 6. 快速启动

### 6.1 环境准备

```bash
# 创建虚拟环境
python -m venv venv
venv\Scripts\activate       # Windows
source venv/bin/activate    # Linux/Mac

# 安装依赖
pip install -r requirements.txt
```

### 6.2 运行应用

```bash
python main.py
```

### 6.3 运行测试

```bash
pytest tests/ -v
```

---

## 7. 核心概念速览

### 7.1 节点 (Node)

每个节点代表一个计算单元（如 `nn.Linear`、`nn.Conv2d`），具有以下核心属性：

- **node_name**: 全局唯一标识符（UUID 或用户指定）
- **node_label**: 显示名称（可自定义）
- **node_type**: 节点类型枚举
- **pins**: 输入/输出引脚字典
- **properties**: 可编辑参数字典
- **details**: 向下游传递的元数据字典
- **module**: 对应的 `nn.Module` 实例

### 7.2 引脚 (Pin)

节点的输入/输出接口：

- **direction**: INPUT 或 OUTPUT
- **data_type**: TENSOR / INT / FLOAT / STRING / BOOL / ANY
- **connections**: 已连接的 Connection 列表
- 悬停显示 shape 信息

### 7.3 连接 (Connection)

两个引脚之间的数据通道：

- **source_pin**: 输出引脚
- **target_pin**: 输入引脚
- 支持禁用/启用
- 可视化显示数据流向

### 7.4 节点图 (NodeGraph)

管理节点和连接的容器：

- 支持拓扑排序确定执行顺序
- 支持子图（SubNet 内部）
- 路径系统（`/obj/model/conv1`）

### 7.5 路径系统

```
/obj/           ← 模型构建空间（动态图逻辑只能在此创建）
  ├── nnmodel/  ← 主模型节点
  │   ├── conv1
  │   ├── relu1
  │   ├── subnet1/
  │   │   ├── conv_a
  │   │   └── relu_a
  │   └── linear1
  │
/vis/           ← 可视化控制空间
  └── visdom/   ← Visdom 监控配置
  
/train/         ← 训练控制空间
  ├── dataset/  ← 数据集配置
  ├── dataloader/ ← 数据加载器
  └── optimizer/  ← 优化器配置
```

---

## 8. 设计原则

1. **关注点分离**: Core（数据模型）与 UI（视图）严格分离，通过信号/回调通信
2. **可扩展性**: 所有节点通过注册表管理，新节点只需继承 `Node` 基类并注册
3. **可序列化**: 所有状态均可序列化为 JSON，支持项目保存/加载/版本迁移
4. **撤销/重做**: 所有用户操作封装为命令对象，支持完整的撤销/重做
5. **线程安全**: 训练过程在独立线程运行，通过 Qt 信号与 UI 通信
6. **容错性**: 节点执行异常不会导致整个图崩溃，错误状态可视化显示

---

*文档版本: v1.0*  
*最后更新: 2026-02-11*
